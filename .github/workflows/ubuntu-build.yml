name: Ubuntu Build Test

on:
  push:
    branches: [ main, mako-dev ]
  pull_request:
    branches: [ main, mako-dev ]

jobs:
  build-ubuntu-22:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      
    steps:
    - name: Install latest Git
      run: |
        sudo apt-get update
        sudo apt-get install -y git
        git --version

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
        
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y sudo curl git
        bash apt_packages.sh
        
    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DPAXOS_LIB_ENABLED=1 -DMICRO_BENCHMARK=0
        
    - name: Build libmako
      run: |
        cd build
        make -j$(nproc) mako
        
    - name: Build dbtest
      run: |
        cd build
        make -j$(nproc) dbtest
      timeout-minutes: 30
      
    - name: Verify build
      run: |
        ls -la build/dbtest
        ls -la build/libmako.a
